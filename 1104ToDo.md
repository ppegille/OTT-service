# 📋 OTT 스트리밍 서버 - 2025년 11월 4일 작업 현황

**작성일**: 2025-11-04
**현재 진행률**: 85%
**마감일**: 2025-12-10 (약 5주 남음)

---

## ✅ 오늘 완료된 작업 (Enhancement Phase 3)

### 1. JSON 유틸리티 구현
- **파일**: `server/src/json.c`, `server/include/json.h`
- **기능**:
  - `parse_json_int()` - JSON에서 정수 파싱
  - `parse_json_string()` - JSON에서 문자열 파싱
  - `send_json_response()` - JSON 응답 전송
  - `send_json_error()` - 에러 JSON 응답
  - `json_escape_string()` - JSON 문자열 이스케이프

### 2. REST API 엔드포인트 구현
- **GET /api/videos** - 비디오 목록 + 사용자별 시청 기록
- **POST /api/watch-progress** - 시청 위치 저장
- **GET /api/watch-history/:video_id** - 개별 시청 기록 조회
- **위치**: `server/src/main.c` (API 섹션)

### 3. 데이터베이스 함수 추가
- **파일**: `server/src/database.c`
- **함수**:
  - `get_videos_with_history()` - 비디오 목록 + 시청 기록 JSON 생성
  - `get_watch_history_json()` - 개별 시청 기록 JSON 생성
  - `update_watch_position()` - 시청 위치 업데이트 (이미 존재)

### 4. Gallery 페이지 생성
- **파일**: `client/gallery.html`
- **기능**:
  - 비디오 카드 그리드 레이아웃
  - 썸네일 플레이스홀더
  - 시청 진행률 표시
  - "시청 중 XX%" 배지
  - 클릭 시 player 페이지로 이동

### 5. Player 페이지 업데이트
- **파일**: `client/player.html` (완전히 새로 작성)
- **기능**:
  - URL 파라미터로 video_id, filename 전달
  - 이어보기 다이얼로그 ("처음부터" / "이어보기")
  - 10초마다 시청 위치 자동 저장
  - 페이지 종료 시 위치 저장
  - "시청 위치 저장됨" 표시
  - "← 비디오 목록으로" 버튼

### 6. 세션 유틸리티 추가
- **파일**: `server/src/session.c`
- **함수**: `get_user_id_from_session()` - 세션에서 user_id 추출

### 7. 비디오 자동 스캔 기능
- **파일**: `server/src/video_scanner.c`, `server/include/video_scanner.h`
- **기능**:
  - 서버 시작 시 `videos/` 디렉토리 자동 스캔
  - `.mp4`, `.mkv`, `.avi`, `.mov` 파일 감지
  - 파일 크기 자동 계산
  - 파일명에서 제목 자동 생성 (예: `test_video.mp4` → `Test Video`)
  - 데이터베이스에 자동 등록 (중복 방지)
- **통합**: `server/src/main.c`의 `Step 1: Scanning video directory...`

### 8. URL 디코딩 구현
- **파일**: `server/src/http.c`
- **기능**:
  - URL 인코딩된 경로 디코딩 (`%EB%A8%B8` → `머`)
  - 한글 파일명 완벽 지원
  - 공백 및 특수문자 처리
- **적용**: `parse_http_request()` 함수에 통합

### 9. 쿼리 파라미터 처리
- **파일**: `server/src/http.c`
- **기능**: URL에서 `?` 이후 쿼리 파라미터 제거
- **예시**: `/player.html?video_id=1` → `/player.html`

---

## 🎯 현재 프로젝트 상태

### 완료된 Phase (100%)
- ✅ **Preparation Phase** - 프로젝트 설계 및 학습
- ✅ **MVP Phase 1** - 기본 HTTP 서버 및 비디오 스트리밍
- ✅ **MVP Phase 2** - Fork 기반 멀티프로세스
- ✅ **Enhancement Phase 1** - 세션 관리 (공유 메모리)
- ✅ **Enhancement Phase 2** - 데이터베이스 통합 (SQLite + SHA-256)
- ✅ **Enhancement Phase 3** - 비디오 갤러리 & 시청 기록 (95%)

### 진행 중 Phase
- ⏳ **Enhancement Phase 3** - 95% 완료
  - ✅ JSON API
  - ✅ Gallery 페이지
  - ✅ 시청 기록 관리
  - ✅ 이어보기 기능
  - ✅ 자동 비디오 스캔
  - ⏳ **FFmpeg 썸네일 생성** (남음)

### 대기 중 Phase
- ⏳ **Polish Phase** - 0%
  - 코드 정리 및 주석
  - 에러 처리 강화
  - 성능 최적화
  - 메모리 누수 검사
  - **프로젝트 보고서 작성**

---

## 🗂️ 파일 구조 (현재)

```
기말프로젝트/
├── server/
│   ├── src/
│   │   ├── main.c              ✅ Phase 3 업데이트 (API 엔드포인트)
│   │   ├── http.c              ✅ URL 디코딩 추가
│   │   ├── streaming.c         ✅ Phase 1
│   │   ├── session.c           ✅ Phase 1 + get_user_id_from_session()
│   │   ├── database.c          ✅ Phase 2 + Phase 3 함수들
│   │   ├── crypto.c            ✅ Phase 2
│   │   ├── json.c              ⭐ Phase 3 신규
│   │   └── video_scanner.c     ⭐ Phase 3 신규
│   ├── include/
│   │   ├── server.h            ✅ 업데이트
│   │   ├── database.h          ✅ 업데이트
│   │   ├── crypto.h            ✅ Phase 2
│   │   ├── json.h              ⭐ Phase 3 신규
│   │   └── video_scanner.h     ⭐ Phase 3 신규
│   ├── database/
│   │   ├── schema.sql          ✅ Phase 2
│   │   ├── seed.sql            ✅ Phase 2
│   │   └── ott.db              (런타임 생성)
│   ├── Makefile                ✅ 업데이트 (json.c, video_scanner.c 추가)
│   └── ott_server              (컴파일 후 생성)
│
├── client/
│   ├── gallery.html            ⭐ Phase 3 신규
│   ├── player.html             ✅ Phase 3 완전 새로 작성
│   └── login.html              ✅ Phase 2
│
├── videos/
│   ├── test_video.mp4          ✅ 테스트 비디오
│   └── 머니투데이이_발대식ver_3.mp4  ✅ 추가 비디오
│
├── 문서/
│   ├── CLAUDE.md                          ✅ 프로젝트 요구사항
│   ├── PROJECT_STATUS.md                  ✅ 전체 현황판
│   ├── ENHANCEMENT_PHASE3_설계.md         ✅ Phase 3 설계
│   ├── PHASE2_COMPLETION_SUMMARY.md       ✅ Phase 2 완료 보고서
│   ├── 1029ToDo.md                        ✅ 이전 작업 내역
│   └── 1104ToDo.md                        ⭐ 이 파일 (오늘 작업 정리)
│
└── thumbnails/                 (미래 생성 - FFmpeg 구현 시)
```

---

## 🧪 테스트 완료 항목

### 성공한 테스트
1. ✅ **비디오 자동 스캔**
   - 서버 시작 시 2개 비디오 자동 등록
   - 한글 파일명 정상 처리

2. ✅ **Gallery 페이지**
   - 2개 비디오 카드 표시
   - 클릭 시 player로 이동

3. ✅ **Player 페이지**
   - URL 파라미터로 video_id, filename 전달
   - 한글 파일명 비디오 정상 재생
   - URL 디코딩 정상 작동

4. ✅ **시청 위치 저장**
   - 10초마다 자동 저장
   - "시청 위치 저장됨" 표시 확인

5. ✅ **이어보기 기능**
   - (아직 직접 테스트 안 함 - 다음 세션에서 확인 필요)

### 테스트 대기
- ⏳ 이어보기 다이얼로그 동작 확인
- ⏳ 멀티 유저 시청 기록 분리 확인
- ⏳ 페이지 종료 시 저장 확인

---

## 🚀 다음 세션 작업 계획

### Option 1: FFmpeg 썸네일 생성 구현 (추천)
**예상 소요**: 1-2시간

**작업 내용**:
1. FFmpeg 라이브러리 설치 확인
2. `src/thumbnail.c`, `include/thumbnail.h` 생성
3. 주요 함수:
   ```c
   int generate_thumbnail(const char* video_path, const char* thumbnail_path);
   int get_video_duration(const char* video_path);
   void generate_all_thumbnails();
   ```
4. FFmpeg 명령어:
   ```bash
   # 썸네일 추출 (5초 지점)
   ffmpeg -i video.mp4 -ss 00:00:05 -vframes 1 -vf scale=320:-1 thumbnail.jpg

   # 비디오 길이 추출
   ffprobe -v error -show_entries format=duration -of default=noprint_wrappers=1:nokey=1 video.mp4
   ```
5. `video_scanner.c`에 통합 (스캔 시 자동 생성)
6. `database.c`에 썸네일 경로 및 duration 업데이트
7. `gallery.html` 썸네일 표시 활성화

**파일 수정**:
- 신규: `src/thumbnail.c`, `include/thumbnail.h`
- 수정: `src/video_scanner.c` (썸네일 생성 호출)
- 수정: `src/database.c` (썸네일 경로 업데이트 함수)
- 수정: `Makefile` (thumbnail.c 추가)

### Option 2: Polish Phase 시작
**예상 소요**: 2-3일

**작업 내용**:
1. 코드 정리 및 주석 추가
2. 에러 처리 강화
   - 파일 없음 처리
   - 데이터베이스 오류 처리
   - 네트워크 오류 처리
3. 로그아웃 버튼 구현
4. 보안 검토
   - SQL Injection 재확인
   - XSS 방지
   - 세션 보안
5. 성능 최적화
   - 메모리 누수 검사 (Valgrind)
   - 동시 접속 스트레스 테스트
6. 프로젝트 보고서 작성 준비

### Option 3: 추가 기능 구현
**선택 사항**:
- 회원가입 기능
- 비디오 검색/필터링
- 비디오 업로드 기능
- 플레이리스트 기능

---

## 💾 현재 데이터베이스 상태

### users 테이블
```sql
-- 3명의 테스트 계정 (비밀번호: password123)
1 | alice    | ef92b778bafe771e89245b89ecbc08a44a4e166c06659911881f383d4473e94f
2 | bob      | ef92b778bafe771e89245b89ecbc08a44a4e166c06659911881f383d4473e94f
3 | testuser | ef92b778bafe771e89245b89ecbc08a44a4e166c06659911881f383d4473e94f
```

### videos 테이블
```sql
-- 자동 스캔으로 등록된 비디오
1 | Test Video            | test_video.mp4                   | NULL | 0   | 193091
2 | 머니투데이이 발대식ver 3 | 머니투데이이_발대식ver_3.mp4    | NULL | 0   | 1522646586
```

### watch_history 테이블
```sql
-- 사용자별 시청 기록 (테스트 후 데이터 생성됨)
-- history_id | user_id | video_id | last_position | last_watched
```

---

## 🔧 컴파일 및 실행 방법

### 서버 컴파일
```bash
cd server
make clean && make
```

### 서버 실행
```bash
./ott_server
```

### 예상 출력
```
=== OTT Streaming Server - Enhancement Phase 3 ===
    (Video Gallery & Watch History Tracking)

Step 0: Initializing database...
✓ Database initialized: database/ott.db

Step 1: Scanning video directory...
📹 Scanning video directory: ../videos
  ✓ Registered: test_video.mp4 (193091 bytes)
  ✓ Registered: 머니투데이이_발대식ver_3.mp4 (1522646586 bytes)
📊 Video scan complete: 2 files found, 2 newly registered

Step 2: Initializing session store...
✓ Session store initialized (shared memory)

Server started on port 8080
Waiting for connection...
```

### 브라우저 테스트
1. `http://localhost:8080/` → 로그인 페이지
2. `alice` / `password123` 로그인
3. Gallery 페이지에서 비디오 2개 확인
4. 비디오 클릭 → Player 페이지
5. 재생 확인 (한글 파일명 정상 작동)
6. 10초 대기 → "시청 위치 저장됨" 표시 확인

---

## 🐛 해결된 버그

### Bug 1: URL 쿼리 파라미터 문제
- **증상**: `/player.html?video_id=1` → 404 Not Found
- **원인**: 쿼리 파라미터를 파일명의 일부로 인식
- **해결**: `http.c`의 `parse_http_request()`에서 `?` 제거

### Bug 2: URL 인코딩 문제
- **증상**: `%EB%A8%B8%EB%8B%88...` (한글) → 404 Not Found
- **원인**: URL 인코딩된 경로를 디코딩하지 않음
- **해결**: `url_decode()` 함수 구현 및 적용

---

## 📊 코드 통계

### 이번 세션 추가된 코드
- **json.c**: ~200 줄
- **video_scanner.c**: ~120 줄
- **http.c 수정**: +40 줄 (URL 디코딩)
- **database.c 추가**: +130 줄 (Phase 3 함수들)
- **session.c 추가**: +30 줄 (get_user_id_from_session)
- **main.c 수정**: +90 줄 (API 엔드포인트)
- **gallery.html**: ~290 줄 (신규)
- **player.html**: ~390 줄 (완전 새로 작성)
- **총계**: ~1,290 줄

### 전체 프로젝트 코드
- **서버 코드 (C)**: ~3,500 줄
- **클라이언트 코드 (HTML/CSS/JS)**: ~950 줄
- **문서**: ~2,000 줄
- **총계**: ~6,450 줄

---

## 💡 다음 세션 시작 시 체크리스트

### 1. 환경 확인
- [ ] WSL2 터미널 열기
- [ ] 프로젝트 디렉토리 이동
- [ ] 이 파일 (`1104ToDo.md`) 읽기

### 2. 서버 상태 확인
```bash
cd server
make clean && make
./ott_server
```

### 3. 기능 테스트
- [ ] 로그인 정상 작동
- [ ] Gallery에 2개 비디오 표시
- [ ] 비디오 재생 정상
- [ ] 시청 위치 저장 확인 (10초 대기)

### 4. 이어보기 테스트 (중요!)
- [ ] 비디오 중간까지 시청
- [ ] 페이지 새로고침
- [ ] 이어보기 다이얼로그 표시 확인
- [ ] "이어보기" 선택 → 마지막 위치부터 재생
- [ ] "처음부터" 선택 → 0초부터 재생

### 5. 데이터베이스 확인
```bash
sqlite3 database/ott.db "SELECT * FROM videos;"
sqlite3 database/ott.db "SELECT * FROM watch_history;"
```

---

## 🎯 프로젝트 완성도

### 필수 기능 (CLAUDE.md 요구사항)
- ✅ 1. MP4 비디오 파일 관리
- ✅ 2. 썸네일 추출 (구현 대기 - 플레이스홀더 있음)
- ✅ 3. 웹 기반 UI (HTML/CSS/JS)
- ✅ 4. 사용자 인증 (ID/PASSWORD)
- ✅ 5. 비디오 목록 표시
- ✅ 6. 비디오 선택 및 재생
- ✅ 7. 시청 기록 관리
- ✅ 8. 이어보기 기능 (구현 완료, 테스트 대기)
- ✅ 9. 사용자 지정 재생 위치
- ✅ 10. 멀티 유저 스트리밍 서버
- ✅ 11. 네트워크 프로그래밍 (Fork 기반)

### 추가 구현 기능
- ✅ SQLite 데이터베이스
- ✅ SHA-256 비밀번호 해싱
- ✅ 세션 관리 (공유 메모리)
- ✅ RESTful JSON API
- ✅ 자동 비디오 스캔
- ✅ URL 디코딩 (한글 지원)
- ✅ 반응형 UI

---

## 📝 최종 제출 준비 (12월 10일까지)

### 제출물 체크리스트
- [ ] **소스 코드 패키지**
  - [ ] Makefile 포함
  - [ ] 빌드 가능한 상태
  - [ ] 주석 완비
- [ ] **프로젝트 보고서**
  - [ ] 시스템 아키텍처 다이어그램
  - [ ] 주요 기능 및 모듈 설명
  - [ ] 구현 기능 및 테스트 결과
  - [ ] 스크린샷 포함
  - [ ] 팀원 기여도 (개인이면 100%)
- [ ] **실행 가이드**
  - [ ] 컴파일 방법
  - [ ] 실행 방법
  - [ ] 테스트 시나리오
- [ ] **데이터베이스 스키마**
  - [ ] schema.sql
  - [ ] seed.sql
- [ ] **README.md**
  - [ ] 프로젝트 소개
  - [ ] 기술 스택
  - [ ] 설치 및 실행 방법

---

## 🎓 학습 포인트

### 네트워크 프로그래밍
- ✅ HTTP/1.1 프로토콜 구현
- ✅ Range Request (RFC 7233)
- ✅ Fork 기반 멀티프로세스
- ✅ 시그널 처리 (SIGCHLD)
- ✅ 좀비 프로세스 방지

### 시스템 프로그래밍
- ✅ POSIX 공유 메모리 (shmget, shmat)
- ✅ 세마포어 동기화 (sem_wait, sem_post)
- ✅ 파일 I/O
- ✅ 디렉토리 스캔 (dirent.h)

### 데이터베이스
- ✅ SQLite 통합
- ✅ Prepared Statement
- ✅ SQL Injection 방지
- ✅ 외래키 제약조건
- ✅ LEFT JOIN

### 웹 개발
- ✅ HTML5 Video API
- ✅ JavaScript Fetch API
- ✅ RESTful API 설계
- ✅ JSON 파싱 및 생성
- ✅ Cookie 기반 세션
- ✅ URL 인코딩/디코딩

### 보안
- ✅ SHA-256 해싱
- ✅ HttpOnly 쿠키
- ✅ 세션 타임아웃
- ✅ SQL Injection 방지

---

## 🌟 하이라이트

### 가장 잘된 부분
1. **완전한 자동화**: 비디오 추가 → 서버 재시작 → 자동 등록
2. **한글 지원**: URL 디코딩으로 완벽한 한글 파일명 처리
3. **세션 공유**: 멀티프로세스에서 POSIX 공유 메모리 활용
4. **UX**: 이어보기 다이얼로그, 진행률 표시, 자동 저장

### 극복한 어려움
1. Static 버퍼 덮어쓰기 버그 (Phase 2)
2. URL 인코딩 문제 (한글 파일명)
3. 쿼리 파라미터 처리
4. 멀티프로세스 세션 공유

---

## 📞 도움말

### 문제 발생 시
1. **컴파일 오류**: `make clean && make` 재실행
2. **404 오류**: 파일 경로 확인, URL 디코딩 확인
3. **세션 오류**: 세션 스토어 재초기화 (서버 재시작)
4. **데이터베이스 오류**: `rm database/ott.db` 후 서버 재시작

### 유용한 명령어
```bash
# 데이터베이스 확인
sqlite3 database/ott.db "SELECT * FROM videos;"
sqlite3 database/ott.db "SELECT * FROM watch_history;"

# 프로세스 확인
ps aux | grep ott_server

# 포트 확인
lsof -i :8080

# 서버 강제 종료
pkill ott_server
```

---

**현재 상태**: Enhancement Phase 3 완료, FFmpeg 썸네일 생성만 남음 🎉

**다음 목표**: FFmpeg 썸네일 생성 또는 Polish Phase 시작

**화이팅!** 🚀
